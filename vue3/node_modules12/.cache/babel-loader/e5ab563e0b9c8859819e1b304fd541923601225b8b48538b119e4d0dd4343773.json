{"ast":null,"code":"import { createElementVNode as _createElementVNode, vModelText as _vModelText, withDirectives as _withDirectives, toDisplayString as _toDisplayString, openBlock as _openBlock, createElementBlock as _createElementBlock, createCommentVNode as _createCommentVNode, createTextVNode as _createTextVNode, withModifiers as _withModifiers } from \"vue\";\nconst _hoisted_1 = [\"disabled\"];\nconst _hoisted_2 = {\n  key: 0\n};\nconst _hoisted_3 = {\n  key: 1\n};\nimport { ref, watch } from 'vue';\nimport { sendApi } from '@/utils/api';\nexport default {\n  __name: 'Step1',\n  emits: ['success', 'valid'],\n  setup(__props, {\n    emit: __emit\n  }) {\n    const message = ref('');\n    const submitDisabled = ref(false);\n    const sentOnce = ref(false);\n    const showSend = ref(false);\n    const remainingTime = ref(0);\n    const emit = __emit;\n    const phone = ref('');\n    let interval = null;\n    watch(phone, async val => {\n      const isValid = /^09\\d{9}$/.test(val);\n      if (isValid && !sentOnce) {\n        try {\n          const response = await sendApi({\n            action: 'save_phone',\n            data: val,\n            control: 'login'\n          });\n          if (response.status === 'success') {\n            sentOnce.value = true;\n            showSend.value = true;\n            emit('valid', true);\n          }\n        } catch (e) {\n          console.error('خطا در ارسال شماره:', e);\n        }\n      } else if (!isValid && sentOnce) {\n        try {\n          const responseDel = await sendApi({\n            control: 'security',\n            action: 'delete_phone'\n          });\n          if (responseDel.status === 'success') {\n            sentOnce.value = false;\n            showSend.value = false;\n            emit('valid', false);\n          }\n        } catch (e) {\n          console.error('خطا در حذف شماره:', e);\n        }\n      }\n    });\n    const submitPhone = async () => {\n      if (submitDisabled) return;\n      try {\n        const response = await sendApi({\n          action: 'send_phone_login',\n          data: phone.value,\n          control: 'login'\n        });\n        if (response.status === 'success') {\n          message.value = 'شماره با موفقیت ارسال شد. لطفاً کد پیامکی را وارد کنید.';\n          localStorage.setItem('login_step', '2');\n          localStorage.setItem('phone', phone.value);\n          const expireTime = now + 60000;\n          localStorage.setItem('resend_code_timer', expireTime);\n          startTimer();\n          emit('success', phone.value);\n          showSend.value = true;\n          sentOnce.value = true;\n        } else {\n          message.value = response.message || 'ارسال موفق نبود';\n        }\n      } catch (error) {\n        message.value = 'خطا در ارسال شماره.';\n        console.error(error);\n      }\n    };\n    const startTimer = () => {\n      const now = Date.now();\n      const expireTime = now + 30000;\n      localStorage.setItem('submit_phone_timer', expireTime);\n      updateRemainingTime();\n      interval = setInterval(updateRemainingTime, 1000);\n    };\n    const updateRemainingTime = () => {\n      submitDisabled.value = true;\n      const expireTime = parseInt(localStorage.getItem('submit_phone_timer') || 0);\n      const now = Date.now();\n      const diff = Math.ceil((expireTime - now) / 1000);\n      remainingTime.value = diff > 0 ? diff : 0;\n      if (remainingTime.value <= 0 && interval) {\n        submitDisabled.value = false;\n        clearInterval(interval);\n        interval = null;\n      }\n    };\n    onMounted(() => {\n      updateRemainingTime();\n      interval = setInterval(updateRemainingTime, 1000);\n    });\n    onUnmounted(() => {\n      if (interval) clearInterval(interval);\n    });\n    return (_ctx, _cache) => {\n      return _openBlock(), _createElementBlock(\"form\", {\n        onSubmit: _withModifiers(submitPhone, [\"prevent\"])\n      }, [_cache[2] || (_cache[2] = _createElementVNode(\"label\", {\n        for: \"phone\"\n      }, \"شماره تلفن\", -1)), _withDirectives(_createElementVNode(\"input\", {\n        id: \"phone\",\n        \"onUpdate:modelValue\": _cache[0] || (_cache[0] = $event => phone.value = $event),\n        type: \"tel\",\n        maxlength: \"11\",\n        pattern: \"[0-9]*\",\n        placeholder: \"09123456789\",\n        required: \"\"\n      }, null, 512), [[_vModelText, phone.value]]), showSend.value ? (_openBlock(), _createElementBlock(\"button\", {\n        key: 0,\n        disabled: submitDisabled.value,\n        type: \"submit\"\n      }, [_cache[1] || (_cache[1] = _createTextVNode(\" ارسال \")), submitDisabled.value ? (_openBlock(), _createElementBlock(\"span\", _hoisted_2, \"(\" + _toDisplayString(remainingTime.value) + \" ثانیه)\", 1)) : _createCommentVNode(\"\", true)], 8, _hoisted_1)) : _createCommentVNode(\"\", true), message.value ? (_openBlock(), _createElementBlock(\"p\", _hoisted_3, _toDisplayString(message.value), 1)) : _createCommentVNode(\"\", true)], 32);\n    };\n  }\n};","map":{"version":3,"names":["ref","watch","sendApi","message","submitDisabled","sentOnce","showSend","remainingTime","emit","__emit","phone","interval","val","isValid","test","response","action","data","control","status","value","e","console","error","responseDel","submitPhone","localStorage","setItem","expireTime","now","startTimer","Date","updateRemainingTime","setInterval","parseInt","getItem","diff","Math","ceil","clearInterval","onMounted","onUnmounted"],"sources":["D:/GitHub/ci3-vue3/vue3/src/components/home/PhoneLogin/Step1.vue"],"sourcesContent":["<template>\r\n    <form @submit.prevent=\"submitPhone\">\r\n        <label for=\"phone\">شماره تلفن</label>\r\n        <input\r\n          id=\"phone\"\r\n          v-model=\"phone\"\r\n          type=\"tel\"\r\n          maxlength=\"11\"\r\n          pattern=\"[0-9]*\"\r\n          placeholder=\"09123456789\"\r\n          required\r\n        />\r\n        <button v-if=\"showSend\" :disabled=\"submitDisabled\" type=\"submit\">\r\n            ارسال\r\n            <span v-if=\"submitDisabled\">({{ remainingTime }} ثانیه)</span>\r\n        </button>\r\n        <p v-if=\"message\">{{ message }}</p>\r\n    </form>\r\n</template>\r\n<script setup>\r\n    import { ref,watch } from 'vue'\r\n    import { sendApi } from '@/utils/api'\r\n    const message=ref('')\r\n    const submitDisabled=ref(false)\r\n    const sentOnce=ref(false)\r\n    const showSend=ref(false)\r\n    const remainingTime=ref(0)\r\n    const emit = defineEmits(['success', 'valid'])\r\n    const phone=ref('')\r\n    let interval=null;\r\n    watch(phone,async (val) => {\r\n        const isValid = /^09\\d{9}$/.test(val)\r\n        if (isValid && !sentOnce) {\r\n            try {\r\n                const response = await sendApi({ \r\n                    action: 'save_phone',\r\n                    data: val,\r\n                    control:'login'\r\n                })\r\n                if (response.status === 'success') {\r\n                    sentOnce.value = true\r\n                    showSend.value = true\r\n                    emit('valid', true)\r\n                }\r\n            } catch (e) {\r\n                console.error('خطا در ارسال شماره:', e)\r\n            }\r\n        } else if (!isValid && sentOnce) {\r\n            try {\r\n                const responseDel = await sendApi({ \r\n                    control:'security',\r\n                    action: 'delete_phone'\r\n                })\r\n                if (responseDel.status === 'success') {\r\n                    sentOnce.value = false\r\n                    showSend.value = false\r\n                    emit('valid', false)\r\n                }\r\n            } catch (e) {\r\n                console.error('خطا در حذف شماره:', e)\r\n            }\r\n        }\r\n    })\r\n    const submitPhone= async () => {\r\n        if (submitDisabled) return\r\n        try {\r\n            const response = await sendApi({ \r\n                action: 'send_phone_login',\r\n                data: phone.value,\r\n                control:'login'\r\n            })\r\n            if (response.status === 'success') {\r\n                message.value = 'شماره با موفقیت ارسال شد. لطفاً کد پیامکی را وارد کنید.'\r\n                localStorage.setItem('login_step', '2')\r\n                localStorage.setItem('phone', phone.value)\r\n                const expireTime = now + 60000 \r\n                localStorage.setItem('resend_code_timer', expireTime)\r\n                startTimer()\r\n                emit('success', phone.value)\r\n                showSend.value = true\r\n                sentOnce.value = true\r\n            } else {\r\n                message.value = response.message || 'ارسال موفق نبود'\r\n            }\r\n        } catch (error) {\r\n            message.value = 'خطا در ارسال شماره.'\r\n            console.error(error)\r\n        }\r\n    }\r\n    const startTimer = () => {\r\n        const now = Date.now()\r\n        const expireTime = now + 30000 \r\n        localStorage.setItem('submit_phone_timer', expireTime)\r\n        updateRemainingTime()\r\n        interval = setInterval(updateRemainingTime, 1000)\r\n    }\r\n    const updateRemainingTime = () => {\r\n        submitDisabled.value=true\r\n        const expireTime = parseInt(localStorage.getItem('submit_phone_timer') || 0)\r\n        const now = Date.now()\r\n        const diff = Math.ceil((expireTime - now) / 1000)\r\n        remainingTime.value = diff > 0 ? diff : 0\r\n        if (remainingTime.value <= 0 && interval) {\r\n            submitDisabled.value=false\r\n            clearInterval(interval)\r\n            interval = null\r\n        }\r\n    }\r\n    onMounted(() => {\r\n        updateRemainingTime()\r\n        interval = setInterval(updateRemainingTime, 1000)\r\n    })\r\n    onUnmounted(() => {\r\n        if (interval) clearInterval(interval)\r\n    })\r\n</script>"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}