{"ast":null,"code":"import \"core-js/modules/es.iterator.constructor.js\";\nimport \"core-js/modules/es.iterator.filter.js\";\nimport \"core-js/modules/es.iterator.find.js\";\nimport \"core-js/modules/es.iterator.for-each.js\";\nimport \"core-js/modules/es.iterator.map.js\";\nimport \"core-js/modules/es.set.difference.v2.js\";\nimport \"core-js/modules/es.set.intersection.v2.js\";\nimport \"core-js/modules/es.set.is-disjoint-from.v2.js\";\nimport \"core-js/modules/es.set.is-subset-of.v2.js\";\nimport \"core-js/modules/es.set.is-superset-of.v2.js\";\nimport \"core-js/modules/es.set.symmetric-difference.v2.js\";\nimport \"core-js/modules/es.set.union.v2.js\";\nimport { unref as _unref, toDisplayString as _toDisplayString, openBlock as _openBlock, createElementBlock as _createElementBlock, createCommentVNode as _createCommentVNode, createTextVNode as _createTextVNode, createElementVNode as _createElementVNode, createVNode as _createVNode } from \"vue\";\nconst _hoisted_1 = {\n  key: 0,\n  class: \"badge\"\n};\nconst _hoisted_2 = {\n  key: 0,\n  class: \"dropdown\",\n  style: {\n    \"max-height\": \"400px\",\n    \"overflow-y\": \"auto\"\n  }\n};\nimport { ref, onMounted, watch } from 'vue';\nimport NotificationList from '@/components/tooles/nav/NotificationList.vue';\nimport { BASE_URL } from '@/config';\nimport { useNotificationStore } from '@/stores/notification';\nimport { usePollingWithCompare } from '@/composables/usePollingWithCompare';\nimport { useInfiniteScroll } from '@/composables/useInfiniteScroll';\nexport default {\n  __name: 'NotificationMenu',\n  setup(__props) {\n    const logo = BASE_URL + '/assets/images/logo.png';\n    const song = BASE_URL + '/assets/song/notif.mp3';\n    const showList = ref(false);\n    const notifSound = ref(null);\n    const store = useNotificationStore();\n    function toggleList() {\n      showList.value = !showList.value;\n    }\n    function playSound() {\n      notifSound.value?.play().catch(() => {});\n    }\n    function showNativeNotification(title, body) {\n      if (Notification.permission === 'granted') {\n        const notification = new Notification(title, {\n          body,\n          icon: logo\n        });\n        notification.onclick = () => {\n          window.focus();\n          notification.close();\n        };\n      }\n    }\n    onMounted(() => {\n      if (Notification.permission === 'default') {\n        Notification.requestPermission();\n      }\n    });\n\n    // ŸæŸàŸÑŸà€åŸÜ⁄Ø ŸÜŸàÿ™€åŸÅ€å⁄©€åÿ¥ŸÜ‚ÄåŸáÿß ÿ®ÿ±ÿß€å ŸÜŸàÿ™€åŸÅ€å⁄©€åÿ¥ŸÜ‚ÄåŸáÿß€å ÿ¨ÿØ€åÿØ\n    usePollingWithCompare(store.fetchNotifications, {\n      intervalMs: 10000,\n      runOnStart: true,\n      isDifferent: (oldNotifs, newNotifs) => {\n        const oldIds = new Set((oldNotifs || []).map(n => n.id));\n        const newIds = new Set((newNotifs || []).map(n => n.id));\n        return oldNotifs?.length !== newNotifs?.length || [...newIds].some(id => !oldIds.has(id));\n      },\n      onChange: newData => {\n        const newOnes = newData.filter(n => !store.notifications.find(o => o.id === n.id));\n        newOnes.forEach(n => {\n          playSound();\n          showNativeNotification(n.title, n.body);\n          store.pushNotification(n);\n        });\n      }\n    });\n\n    // ÿßÿ≥ÿ™ŸÅÿßÿØŸá ÿßÿ≤ useInfiniteScroll ÿ®ÿ±ÿß€å Ÿàÿß⁄©ÿ¥€å ÿ®€å‚ÄåŸÜŸáÿß€åÿ™ ŸÜŸàÿ™€åŸÅ€å⁄©€åÿ¥ŸÜ‚ÄåŸáÿß\n    const loadMoreTrigger = ref(null);\n    const {\n      items,\n      canLoadMore,\n      setupObserver\n    } = useInfiniteScroll(async ({\n      limit,\n      offset\n    }) => {\n      // Ÿàÿß⁄©ÿ¥€å ÿØÿßÿØŸá ÿßÿ≤ ÿßÿ≥ÿ™Ÿàÿ± ÿ®ÿß limit Ÿà offset\n      const data = await store.fetchNotifications({\n        limit,\n        offset\n      });\n      return data;\n    }, {\n      limit: 10,\n      total: ref(store.notifications.length),\n      immediate: false // ⁄ÜŸàŸÜ ŸæŸàŸÑŸà€åŸÜ⁄Ø Ÿáÿ≥ÿ™ ŸÜ€åÿßÿ≤€å ÿ®Ÿá ŸÑŸàÿØ ÿßŸàŸÑ€åŸá ÿÆŸàÿØ⁄©ÿßÿ± ŸÜ€åÿ≥ÿ™\n    });\n\n    // ŸàŸÇÿ™€å loadMoreTrigger ŸÖŸÇÿØÿßÿ± ⁄Øÿ±ŸÅÿ™ÿå observer ÿ±Ÿà ÿ±ÿßŸá‚ÄåÿßŸÜÿØÿßÿ≤€å ⁄©ŸÜ\n    watch(loadMoreTrigger, el => {\n      if (el) {\n        setupObserver();\n      }\n    });\n\n    // ÿ≤ŸÖÿßŸÜ€å ⁄©Ÿá ŸÅÿ±ÿ≤ŸÜÿØ ÿπŸÜÿµÿ± loadMoreDiv ÿ±ÿß ŸÅÿ±ÿ≥ÿ™ÿßÿØÿå ÿß€åŸÜÿ¨ÿß ÿ∞ÿÆ€åÿ±Ÿá ⁄©ŸÜ\n    function onLoadMoreTriggerReady(el) {\n      loadMoreTrigger.value = el;\n    }\n    return (_ctx, _cache) => {\n      return _openBlock(), _createElementBlock(\"div\", null, [_createElementVNode(\"div\", {\n        class: \"icon-wrapper\",\n        onClick: toggleList,\n        style: {\n          \"cursor\": \"pointer\"\n        }\n      }, [_cache[0] || (_cache[0] = _createTextVNode(\" üîî \")), _unref(store).unreadCount > 0 ? (_openBlock(), _createElementBlock(\"span\", _hoisted_1, _toDisplayString(_unref(store).unreadCount), 1)) : _createCommentVNode(\"\", true)]), showList.value ? (_openBlock(), _createElementBlock(\"div\", _hoisted_2, [_createVNode(NotificationList, {\n        notifications: _unref(items),\n        \"can-load-more\": _unref(canLoadMore),\n        onUpdate: _unref(store).markAsRead,\n        onLoadMoreTriggerReady: onLoadMoreTriggerReady\n      }, null, 8, [\"notifications\", \"can-load-more\", \"onUpdate\"])])) : _createCommentVNode(\"\", true), _createElementVNode(\"audio\", {\n        ref_key: \"notifSound\",\n        ref: notifSound,\n        src: song,\n        preload: \"auto\"\n      }, null, 512)]);\n    };\n  }\n};","map":{"version":3,"names":["ref","onMounted","watch","NotificationList","BASE_URL","useNotificationStore","usePollingWithCompare","useInfiniteScroll","logo","song","showList","notifSound","store","toggleList","value","playSound","play","catch","showNativeNotification","title","body","Notification","permission","notification","icon","onclick","window","focus","close","requestPermission","fetchNotifications","intervalMs","runOnStart","isDifferent","oldNotifs","newNotifs","oldIds","Set","map","n","id","newIds","length","some","has","onChange","newData","newOnes","filter","notifications","find","o","forEach","pushNotification","loadMoreTrigger","items","canLoadMore","setupObserver","limit","offset","data","total","immediate","el","onLoadMoreTriggerReady"],"sources":["D:/GitHub/ci3-vue3/vue3/src/components/tooles/nav/NotificationMenu.vue"],"sourcesContent":["<script setup>\r\nimport { ref, onMounted, watch } from 'vue'\r\nimport NotificationList from '@/components/tooles/nav/NotificationList.vue'\r\nimport { BASE_URL } from '@/config'\r\nimport { useNotificationStore } from '@/stores/notification'\r\nimport { usePollingWithCompare } from '@/composables/usePollingWithCompare'\r\nimport { useInfiniteScroll } from '@/composables/useInfiniteScroll'\r\n\r\nconst logo = BASE_URL + '/assets/images/logo.png'\r\nconst song = BASE_URL + '/assets/song/notif.mp3'\r\n\r\nconst showList = ref(false)\r\nconst notifSound = ref(null)\r\nconst store = useNotificationStore()\r\n\r\nfunction toggleList() {\r\n  showList.value = !showList.value\r\n}\r\n\r\nfunction playSound() {\r\n  notifSound.value?.play().catch(() => {})\r\n}\r\n\r\nfunction showNativeNotification(title, body) {\r\n  if (Notification.permission === 'granted') {\r\n    const notification = new Notification(title, {\r\n      body,\r\n      icon: logo,\r\n    })\r\n    notification.onclick = () => {\r\n      window.focus()\r\n      notification.close()\r\n    }\r\n  }\r\n}\r\n\r\nonMounted(() => {\r\n  if (Notification.permission === 'default') {\r\n    Notification.requestPermission()\r\n  }\r\n})\r\n\r\n// ŸæŸàŸÑŸà€åŸÜ⁄Ø ŸÜŸàÿ™€åŸÅ€å⁄©€åÿ¥ŸÜ‚ÄåŸáÿß ÿ®ÿ±ÿß€å ŸÜŸàÿ™€åŸÅ€å⁄©€åÿ¥ŸÜ‚ÄåŸáÿß€å ÿ¨ÿØ€åÿØ\r\nusePollingWithCompare(store.fetchNotifications, {\r\n  intervalMs: 10000,\r\n  runOnStart: true,\r\n  isDifferent: (oldNotifs, newNotifs) => {\r\n    const oldIds = new Set((oldNotifs || []).map(n => n.id))\r\n    const newIds = new Set((newNotifs || []).map(n => n.id))\r\n    return oldNotifs?.length !== newNotifs?.length || [...newIds].some(id => !oldIds.has(id))\r\n  },\r\n  onChange: (newData) => {\r\n    const newOnes = newData.filter(n => !store.notifications.find(o => o.id === n.id))\r\n    newOnes.forEach(n => {\r\n      playSound()\r\n      showNativeNotification(n.title, n.body)\r\n      store.pushNotification(n)\r\n    })\r\n  }\r\n})\r\n\r\n// ÿßÿ≥ÿ™ŸÅÿßÿØŸá ÿßÿ≤ useInfiniteScroll ÿ®ÿ±ÿß€å Ÿàÿß⁄©ÿ¥€å ÿ®€å‚ÄåŸÜŸáÿß€åÿ™ ŸÜŸàÿ™€åŸÅ€å⁄©€åÿ¥ŸÜ‚ÄåŸáÿß\r\nconst loadMoreTrigger = ref(null)\r\n\r\nconst {\r\n  items,\r\n  canLoadMore,\r\n  setupObserver,\r\n} = useInfiniteScroll(async ({ limit, offset }) => {\r\n  // Ÿàÿß⁄©ÿ¥€å ÿØÿßÿØŸá ÿßÿ≤ ÿßÿ≥ÿ™Ÿàÿ± ÿ®ÿß limit Ÿà offset\r\n  const data = await store.fetchNotifications({ limit, offset })\r\n  return data\r\n}, {\r\n  limit: 10,\r\n  total: ref(store.notifications.length),\r\n  immediate: false, // ⁄ÜŸàŸÜ ŸæŸàŸÑŸà€åŸÜ⁄Ø Ÿáÿ≥ÿ™ ŸÜ€åÿßÿ≤€å ÿ®Ÿá ŸÑŸàÿØ ÿßŸàŸÑ€åŸá ÿÆŸàÿØ⁄©ÿßÿ± ŸÜ€åÿ≥ÿ™\r\n})\r\n\r\n// ŸàŸÇÿ™€å loadMoreTrigger ŸÖŸÇÿØÿßÿ± ⁄Øÿ±ŸÅÿ™ÿå observer ÿ±Ÿà ÿ±ÿßŸá‚ÄåÿßŸÜÿØÿßÿ≤€å ⁄©ŸÜ\r\nwatch(loadMoreTrigger, (el) => {\r\n  if (el) {\r\n    setupObserver()\r\n  }\r\n})\r\n\r\n// ÿ≤ŸÖÿßŸÜ€å ⁄©Ÿá ŸÅÿ±ÿ≤ŸÜÿØ ÿπŸÜÿµÿ± loadMoreDiv ÿ±ÿß ŸÅÿ±ÿ≥ÿ™ÿßÿØÿå ÿß€åŸÜÿ¨ÿß ÿ∞ÿÆ€åÿ±Ÿá ⁄©ŸÜ\r\nfunction onLoadMoreTriggerReady(el) {\r\n  loadMoreTrigger.value = el\r\n}\r\n</script>\r\n\r\n<template>\r\n  <div>\r\n    <div class=\"icon-wrapper\" @click=\"toggleList\" style=\"cursor:pointer;\">\r\n      üîî\r\n      <span class=\"badge\" v-if=\"store.unreadCount > 0\">{{ store.unreadCount }}</span>\r\n    </div>\r\n\r\n    <div class=\"dropdown\" v-if=\"showList\" style=\"max-height: 400px; overflow-y: auto;\">\r\n      <NotificationList\r\n        :notifications=\"items\"\r\n        :can-load-more=\"canLoadMore\"\r\n        @update=\"store.markAsRead\"\r\n        @loadMoreTriggerReady=\"onLoadMoreTriggerReady\"\r\n      />\r\n    </div>\r\n\r\n    <audio ref=\"notifSound\" :src=\"song\" preload=\"auto\"></audio>\r\n  </div>\r\n</template>\r\n<style scoped>\r\n    .icon-wrapper {\r\n        font-size: 24px;\r\n        cursor: pointer;\r\n        position: relative;\r\n    }\r\n    .badge {\r\n        position: absolute;\r\n        top: -6px;\r\n        right: -10px;\r\n        background-color: red;\r\n        color: white;\r\n        border-radius: 50%;\r\n        padding: 2px 6px;\r\n        font-size: 12px;\r\n    }\r\n    .dropdown {\r\n        position: fixed;\r\n        top: 60px;\r\n        left: 0;\r\n        width: 300px;\r\n        background: white;\r\n        border-radius: 10px;\r\n        box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);\r\n    }\r\n</style>"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}