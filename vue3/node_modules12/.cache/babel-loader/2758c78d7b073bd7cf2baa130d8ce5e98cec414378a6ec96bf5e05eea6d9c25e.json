{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport { BASE_URL, API_SECRET_KEY } from '@/config';\nimport router from '@/router';\nlet tokenCache = null;\nlet isGettingToken = false;\nlet isLoggingOut = false;\nasync function getToken() {\n  if (tokenCache && !isGettingToken) return tokenCache;\n  isGettingToken = true;\n  try {\n    const res = await fetch(`${BASE_URL}/create_token`, {\n      method: 'GET',\n      credentials: 'include',\n      headers: {\n        'X-API-KEY': API_SECRET_KEY\n      }\n    });\n    const tokenJson = await res.json();\n    if (tokenJson.code === 401 && tokenJson.status === 'error') {\n      if (!isLoggingOut) {\n        isLoggingOut = true;\n        localStorage.clear();\n        router.push('/');\n      }\n      tokenCache = null;\n      isGettingToken = false;\n      throw new Error('Unauthorized');\n    }\n    tokenCache = tokenJson;\n    isGettingToken = false;\n    return tokenJson;\n  } catch (err) {\n    tokenCache = null;\n    isGettingToken = false;\n    console.error('getToken error:', err);\n    throw err;\n  }\n}\nexport async function sendApi(data = {}, retry = false) {\n  try {\n    const token = await getToken();\n    const response = await fetch(`${BASE_URL}/api`, {\n      method: 'POST',\n      credentials: 'include',\n      headers: {\n        'Content-Type': 'application/json',\n        'Authorization': `Bearer ${token.token}`,\n        'X-API-KEY': API_SECRET_KEY,\n        'X-API-KEY-BACK': token.key\n      },\n      body: JSON.stringify(data)\n    });\n    const result = await response.json();\n    if (result.code === 401 && result.status === 'error' && !retry) {\n      console.warn('[API] Invalid token detected, retrying...');\n      tokenCache = null;\n      return await sendApi(data, true);\n    }\n    if (result.code === 401 && result.status === 'error' && retry) {\n      if (!isLoggingOut) {\n        isLoggingOut = true;\n        localStorage.clear();\n        router.push('/');\n      }\n      throw new Error('Unauthorized after retry');\n    }\n    return result;\n  } catch (err) {\n    tokenCache = null;\n    console.error('API Error:', err);\n    throw err;\n  }\n}","map":{"version":3,"names":["BASE_URL","API_SECRET_KEY","router","tokenCache","isGettingToken","isLoggingOut","getToken","res","fetch","method","credentials","headers","tokenJson","json","code","status","localStorage","clear","push","Error","err","console","error","sendApi","data","retry","token","response","key","body","JSON","stringify","result","warn"],"sources":["D:/GitHub/ci3-vue3/vue3/src/utils/api.js"],"sourcesContent":["import { BASE_URL, API_SECRET_KEY } from '@/config'\r\nimport router from '@/router'\r\nlet tokenCache = null\r\nlet isGettingToken = false\r\nlet isLoggingOut = false\r\nasync function getToken() {\r\n  if (tokenCache && !isGettingToken) return tokenCache;\r\n  isGettingToken = true;\r\n  try {\r\n    const res = await fetch(`${BASE_URL}/create_token`, {\r\n      method: 'GET',\r\n      credentials: 'include',\r\n      headers: {\r\n        'X-API-KEY': API_SECRET_KEY\r\n      }\r\n    });\r\n    const tokenJson = await res.json();\r\n    if (tokenJson.code === 401 && tokenJson.status === 'error') {\r\n      if (!isLoggingOut) {\r\n        isLoggingOut = true;\r\n        localStorage.clear();\r\n        router.push('/');\r\n      }\r\n      tokenCache = null;\r\n      isGettingToken = false;\r\n      throw new Error('Unauthorized');\r\n    }\r\n    tokenCache = tokenJson;\r\n    isGettingToken = false;\r\n    return tokenJson;\r\n  } catch (err) {\r\n    tokenCache = null;\r\n    isGettingToken = false;\r\n    console.error('getToken error:', err);\r\n    throw err;\r\n  }\r\n}\r\nexport async function sendApi(data = {}, retry = false) {\r\n  try {\r\n    const token = await getToken();\r\n    const response = await fetch(`${BASE_URL}/api`, {\r\n      method: 'POST',\r\n      credentials: 'include',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'Authorization': `Bearer ${token.token}`,\r\n        'X-API-KEY': API_SECRET_KEY,\r\n        'X-API-KEY-BACK': token.key\r\n      },\r\n      body: JSON.stringify(data)\r\n    });\r\n    const result = await response.json();\r\n    if (result.code === 401 && result.status === 'error' && !retry) {\r\n      console.warn('[API] Invalid token detected, retrying...');\r\n      tokenCache = null;\r\n      return await sendApi(data, true);\r\n    }\r\n    if (result.code === 401 && result.status === 'error' && retry) {\r\n      if (!isLoggingOut) {\r\n        isLoggingOut = true;\r\n        localStorage.clear();\r\n        router.push('/');\r\n      }\r\n      throw new Error('Unauthorized after retry');\r\n    }\r\n    return result;\r\n  } catch (err) {\r\n    tokenCache = null;\r\n    console.error('API Error:', err);\r\n    throw err;\r\n  }\r\n}"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}