{"ast":null,"code":"import \"core-js/modules/es.iterator.constructor.js\";\nimport \"core-js/modules/es.iterator.filter.js\";\nimport \"core-js/modules/es.iterator.find.js\";\nimport \"core-js/modules/es.iterator.for-each.js\";\nimport \"core-js/modules/es.iterator.map.js\";\nimport \"core-js/modules/es.set.difference.v2.js\";\nimport \"core-js/modules/es.set.intersection.v2.js\";\nimport \"core-js/modules/es.set.is-disjoint-from.v2.js\";\nimport \"core-js/modules/es.set.is-subset-of.v2.js\";\nimport \"core-js/modules/es.set.is-superset-of.v2.js\";\nimport \"core-js/modules/es.set.symmetric-difference.v2.js\";\nimport \"core-js/modules/es.set.union.v2.js\";\nimport { unref as _unref, toDisplayString as _toDisplayString, openBlock as _openBlock, createElementBlock as _createElementBlock, createCommentVNode as _createCommentVNode, createTextVNode as _createTextVNode, createElementVNode as _createElementVNode, createVNode as _createVNode } from \"vue\";\nconst _hoisted_1 = {\n  key: 0,\n  class: \"badge\"\n};\nconst _hoisted_2 = {\n  key: 0,\n  class: \"dropdown\"\n};\nimport { ref, watch, onMounted } from 'vue';\nimport NotificationList from '@/components/tooles/nav/NotificationList.vue';\nimport { BASE_URL } from '@/config';\nimport { useNotificationStore } from '@/stores/notification';\nimport { usePollingWithCompare } from '@/composables/usePollingWithCompare';\nimport { useInfiniteScroll } from '@/composables/useInfiniteScroll';\nimport { subscribeToPush } from '@/utils/pushService';\nexport default {\n  __name: 'NotificationMenu',\n  setup(__props) {\n    const logo = BASE_URL + '/assets/images/logo.png';\n    const song = BASE_URL + '/assets/song/notif.mp3';\n    const notifSound = ref(null);\n    const loadMoreTrigger = ref(null);\n    const hasAccess = ref(false);\n    const store = useNotificationStore();\n    function playSound() {\n      notifSound.value?.play().catch(() => {});\n    }\n    function showNativeNotification(title, body) {\n      if (Notification.permission === 'granted') {\n        const notification = new Notification(title, {\n          body,\n          icon: logo\n        });\n        notification.onclick = () => {\n          window.focus();\n          notification.close();\n        };\n      }\n    }\n    function onLoadMoreTriggerReady(el) {\n      loadMoreTrigger.value = el;\n    }\n    function askNotificationPermission() {\n      Notification.requestPermission().then(permission => {\n        if (permission === \"granted\") {\n          if ('serviceWorker' in navigator) {\n            navigator.serviceWorker.register(`${BASE_URL}/assets/sw.js`).then(() => {\n              subscribeToPush();\n            }).catch(err => {\n              console.error('SW registration failed:', err);\n            });\n          }\n        } else {\n          const retry = confirm('Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§ Ù„Ø·ÙØ§Ù‹ Ø¯Ø³ØªØ±Ø³ÛŒ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯. Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ø´ÙˆØ¯ØŸ');\n          if (retry) {\n            askNotificationPermission();\n          }\n        }\n      });\n    }\n    function tog() {\n      store.toggle();\n      if (!hasAccess.value) {\n        askNotificationPermission();\n      }\n    }\n    usePollingWithCompare(() => store.fetchNotifications({\n      limit: 10,\n      offset: 0\n    }), {\n      intervalMs: 10000,\n      runOnStart: true,\n      isDifferent: (old, fresh) => {\n        const oldArray = Array.isArray(old) ? old : [];\n        const freshArray = Array.isArray(fresh) ? fresh : [];\n        const oldIds = new Set(oldArray.map(n => n.id));\n        const freshIds = new Set(freshArray.map(n => n.id));\n        return oldArray.length !== freshArray.length || [...freshIds].some(id => !oldIds.has(id));\n      },\n      onChange: freshData => {\n        const newOnes = freshData.filter(n => !store.notifications.find(o => o.id === n.id));\n        newOnes.forEach(n => {\n          playSound();\n          showNativeNotification(n.title, n.body);\n          store.pushNotification(n);\n        });\n      }\n    });\n    const {\n      canLoadMore,\n      setupObserver\n    } = useInfiniteScroll(({\n      offset\n    }) => store.fetchNotifications({\n      limit: 10,\n      offset\n    }), {\n      immediate: false\n    });\n    onMounted(() => {\n      if (!('Notification' in window)) {\n        alert('Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.');\n        return;\n      }\n      hasAccess.value = Notification.permission === 'granted';\n    });\n    watch(loadMoreTrigger, el => {\n      if (el) setupObserver();\n    });\n    return (_ctx, _cache) => {\n      return _openBlock(), _createElementBlock(\"div\", null, [_createElementVNode(\"div\", {\n        class: \"icon-wrapper\",\n        onClick: tog\n      }, [_cache[0] || (_cache[0] = _createTextVNode(\" ðŸ”” \")), _unref(store).unreadCount > 0 ? (_openBlock(), _createElementBlock(\"span\", _hoisted_1, _toDisplayString(_unref(store).unreadCount), 1)) : _createCommentVNode(\"\", true)]), _unref(store).showList ? (_openBlock(), _createElementBlock(\"div\", _hoisted_2, [_createVNode(NotificationList, {\n        notifications: _unref(store).notifications,\n        \"can-load-more\": _unref(canLoadMore),\n        onUpdate: _unref(store).markAsRead,\n        onLoadMoreTriggerReady: onLoadMoreTriggerReady\n      }, null, 8, [\"notifications\", \"can-load-more\", \"onUpdate\"])])) : _createCommentVNode(\"\", true), _createElementVNode(\"audio\", {\n        ref_key: \"notifSound\",\n        ref: notifSound,\n        src: song,\n        preload: \"auto\"\n      }, null, 512)]);\n    };\n  }\n};","map":{"version":3,"names":["ref","watch","onMounted","NotificationList","BASE_URL","useNotificationStore","usePollingWithCompare","useInfiniteScroll","subscribeToPush","logo","song","notifSound","loadMoreTrigger","hasAccess","store","playSound","value","play","catch","showNativeNotification","title","body","Notification","permission","notification","icon","onclick","window","focus","close","onLoadMoreTriggerReady","el","askNotificationPermission","requestPermission","then","navigator","serviceWorker","register","err","console","error","retry","confirm","tog","toggle","fetchNotifications","limit","offset","intervalMs","runOnStart","isDifferent","old","fresh","oldArray","Array","isArray","freshArray","oldIds","Set","map","n","id","freshIds","length","some","has","onChange","freshData","newOnes","filter","notifications","find","o","forEach","pushNotification","canLoadMore","setupObserver","immediate","alert"],"sources":["D:/GitHub/chat/vue3/src/components/tooles/nav/NotificationMenu.vue"],"sourcesContent":["<script setup>\r\n  import { ref, watch, onMounted } from 'vue'\r\n  import NotificationList from '@/components/tooles/nav/NotificationList.vue'\r\n  import { BASE_URL } from '@/config'\r\n  import { useNotificationStore } from '@/stores/notification'\r\n  import { usePollingWithCompare } from '@/composables/usePollingWithCompare'\r\n  import { useInfiniteScroll } from '@/composables/useInfiniteScroll'\r\n  import { subscribeToPush } from '@/utils/pushService';\r\n  const logo = BASE_URL + '/assets/images/logo.png'\r\n  const song = BASE_URL + '/assets/song/notif.mp3'\r\n  const notifSound = ref(null)\r\n  const loadMoreTrigger = ref(null)\r\n  const hasAccess = ref(false)\r\n  const store = useNotificationStore()\r\n  function playSound() {\r\n    notifSound.value?.play().catch(() => {})\r\n  }\r\n  function showNativeNotification(title, body) {\r\n    if (Notification.permission === 'granted') {\r\n      const notification = new Notification(title, {\r\n        body,\r\n        icon: logo,\r\n      })\r\n      notification.onclick = () => {\r\n        window.focus()\r\n        notification.close()\r\n      }\r\n    }\r\n  }\r\n  function onLoadMoreTriggerReady(el) {\r\n    loadMoreTrigger.value = el\r\n  }\r\n  function askNotificationPermission() {\r\n    Notification.requestPermission().then(permission => {\r\n      if (permission === \"granted\") {\r\n        if ('serviceWorker' in navigator) {\r\n          navigator.serviceWorker.register(`${BASE_URL}/assets/sw.js`)\r\n          .then(() => {\r\n            subscribeToPush();\r\n          })\r\n          .catch(err => {\r\n            console.error('SW registration failed:', err);\r\n          });\r\n        }\r\n      } else {\r\n        const retry = confirm('Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§ Ù„Ø·ÙØ§Ù‹ Ø¯Ø³ØªØ±Ø³ÛŒ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯. Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ø´ÙˆØ¯ØŸ');\r\n        if (retry) {\r\n          askNotificationPermission();\r\n        }\r\n      }\r\n    });\r\n  }\r\n  function tog() {\r\n    store.toggle()\r\n    if (!hasAccess.value) {\r\n      askNotificationPermission()\r\n    }\r\n  }\r\n  usePollingWithCompare(() => store.fetchNotifications({ limit: 10, offset: 0 }), {\r\n    intervalMs: 10000,\r\n    runOnStart: true,\r\n    isDifferent: (old, fresh) => {\r\n      const oldArray = Array.isArray(old) ? old : []\r\n      const freshArray = Array.isArray(fresh) ? fresh : []\r\n      const oldIds = new Set(oldArray.map(n => n.id))\r\n      const freshIds = new Set(freshArray.map(n => n.id))\r\n      return oldArray.length !== freshArray.length || [...freshIds].some(id => !oldIds.has(id))\r\n    },\r\n    onChange: (freshData) => {\r\n      const newOnes = freshData.filter(n => !store.notifications.find(o => o.id === n.id))\r\n      newOnes.forEach(n => {\r\n        playSound()\r\n        showNativeNotification(n.title, n.body)\r\n        store.pushNotification(n)\r\n      })\r\n    }\r\n  })\r\n  const {\r\n    canLoadMore,\r\n    setupObserver,\r\n  } = useInfiniteScroll(\r\n    ({ offset }) => store.fetchNotifications({ limit: 10, offset }),\r\n    { immediate: false }\r\n  )\r\n  onMounted(() => {\r\n    if (!('Notification' in window)) {\r\n      alert('Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.');\r\n      return;\r\n    }\r\n    hasAccess.value = Notification.permission === 'granted'\r\n  });\r\n  watch(loadMoreTrigger, (el) => {\r\n    if (el) setupObserver()\r\n  })\r\n</script>\r\n<template>\r\n  <div>\r\n    <div class=\"icon-wrapper\" @click=\"tog\">\r\n      ðŸ””\r\n      <span class=\"badge\" v-if=\"store.unreadCount > 0\">{{ store.unreadCount }}</span>\r\n    </div>\r\n    <div class=\"dropdown\" v-if=\"store.showList\">\r\n      <NotificationList\r\n        :notifications=\"store.notifications\"\r\n        :can-load-more=\"canLoadMore\"\r\n        @update=\"store.markAsRead\"\r\n        @loadMoreTriggerReady=\"onLoadMoreTriggerReady\"\r\n      />\r\n    </div>\r\n    <audio ref=\"notifSound\" :src=\"song\" preload=\"auto\" />\r\n  </div>\r\n</template>\r\n<style scoped>\r\n  .icon-wrapper {\r\n    font-size: 24px;\r\n    cursor: pointer;\r\n    position: relative;\r\n  }\r\n  .badge {\r\n    top: -6px;\r\n    right: -10px;\r\n    background-color: red;\r\n    color: white;\r\n    border-radius: 50%;\r\n    padding: 2px 6px;\r\n    font-size: 12px;\r\n    position: absolute;\r\n  }\r\n  .dropdown {\r\n    top: 60px;\r\n    left: 0;\r\n    width: 300px;\r\n    background: white;\r\n    border-radius: 10px;\r\n    box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);\r\n    position: fixed;\r\n  }\r\n</style>"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}